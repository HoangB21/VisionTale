# 项目开发需求描述

## 一、功能概述

本项目致力于打造一个融合大语言模型（LLM）与 ComfyUI 的智能创作平台，主要面向小说创作者、插画师以及 AI 生成内容开发者等群体。该平台能够助力用户快速生成创意文本，并结合 AI 技术实现图像生成。其中，LLM 的调用将通过类似 OpenAI 的 API 接口来完成，后端部分则采用 Python 的 FastAPI 框架搭建服务器，其职责是与 ComfyUI 服务器进行交互，并对外提供相应的 API 接口。平台生成的内容以文件夹形式存储，便于管理和扩展。

## 二、项目结构及功能规划

### 项目分层结构

项目采用分层架构设计，主要包括以下几个层次：

1. **API 接口层（controller）** ：负责处理前端请求，对外提供统一的 API 接口，进行参数校验和请求转发，返回处理结果给前端。
2. **业务逻辑层（service）** ：封装具体的业务逻辑，包括文本生成、图像生成、知识图谱管理等功能，调用数据访问层和工具类来完成业务处理。
3. **工具类（utils）** ：提供一些通用的工具方法，如提示词管理、上下文管理、音频生成等。

### 项目文件结构

```
ai-factory/                # 项目根目录
├── server/               # 服务器端代码
│   ├── config/           # 配置文件夹
│   │   ├── config.py     # 配置文件操作接口
│   │   └── config.yaml   # 系统配置文件
│   ├── controllers/      # API 接口层
│   │   ├── project_controller.py # 项目管理相关接口
│   │   ├── chapter_controller.py # 章节管理相关接口
│   │   ├── character_controller.py # 角色管理相关接口
│   │   ├── media_controller.py   # 媒体生成相关接口
│   │   ├── video_controller.py   # 视频生成相关接口
│   │   └── admin_controller.py   # 系统管理接口（包括配置文件修改）
│   ├── services/         # 业务逻辑层
│   │   ├── llm_service.py    # LLM 相关业务逻辑
│   │   ├── image_service.py  # 图像生成相关业务逻辑
│   │   ├── kg_service.py     # 知识图谱管理相关业务逻辑
│   │   ├── singleton_service.py # 单例服务基类
│   │   ├── audio_service.py  # 音频生成相关业务逻辑
│   │   └── video_service.py  # 视频生成相关业务逻辑
│   ├── utils/            # 工具类
│   │   ├── prompt_manager.py # 提示词管理工具
│   │   ├── context_manager.py # 上下文管理工具
│   │   └── file_manager.py   # 文件管理工具
│   ├── prompts/          # 提示词模板文件夹
│   │   ├── novel_writing.txt     # 小说写作提示词模板
│   │   ├── character_generation.txt # 人物生成提示词模板
│   │   └── image_generation.txt  # 图像生成提示词模板
│   └── workflow/         # 工作流配置文件夹
│       └── default_workflow.json # 默认工作流配置文件
├── projects/             # 项目文件夹（与 server 同级）
│   ├── project1/         # 具体项目文件夹
│   │   ├── kg.json       # 知识图谱数据文件
│   │   ├── last_content.txt  # 最新生成的内容，用于维护写作上下文
│   │   ├── chapter1/     # 章节文件夹
│   │   │   ├── content.txt   # 章节内容文件（由 generate_chapter API 生成）
│   │   │   ├── 1/       # 子文件夹
│   │   │   │   ├── span.txt
│   │   │   │   ├── prompt.json
│   │   │   │   ├── image_2025-02-05_10-15-30_seed_12345.png
│   │   │   │   └── audio_2025-02-05_10-15-30.wav
│   │   │   ├── 2/       # 子文件夹
│   │   │   └── ...      # 其他子文件夹
│   │   └── ...          # 其他章节文件夹
│   └── ...              # 其他项目文件夹
└── README.md            # 项目说明文档
```

### 路径配置说明

项目中的路径配置遵循以下规则：

1. **项目文件夹（projects_path）**：

   - 配置值：`../projects/`
   - 说明：相对于 server 目录的上一级目录，与 server 目录同级
   - 用途：存储所有用户创建的项目及其相关文件

2. **提示词模板文件夹（prompts_path）**：

   - 配置值：`prompts/`
   - 说明：相对于 server 目录
   - 用途：存储各类提示词模板文件

3. **工作流配置文件夹（workflow）**：
   - 配置值：`workflow/default_workflow.json`
   - 说明：相对于 server 目录
   - 用途：存储 ComfyUI 的工作流配置文件

所有路径配置均在 `server/config/config.yaml` 文件中定义。在使用相对路径时，server 端的代码会自动根据当前运行环境解析正确的绝对路径。

## 三、API 接口说明

### 1. 项目管理接口 (`project_controller.py`)

**功能描述**：

- 提供与项目管理相关的 API 接口，包括创建项目、获取项目列表、获取项目详情、更新项目名称和删除项目
- 创建项目时会自动创建项目目录和知识图谱文件（kg.json）
- 提供项目信息的增删改查功能

**主要接口**：

- `POST /project/create`：创建新项目，初始化项目目录和知识图谱文件
- `GET /project/info`：获取项目详细信息
- `GET /project/list`：获取所有项目列表
- `PUT /project/update`：更新项目信息
- `DELETE /project/delete`：删除指定项目

### 2. 角色管理接口 (`character_controller.py`)

- 提供角色管理相关的 API 接口，包括获取角色列表、更新角色信息、锁定/解锁角色、删除角色等功能
- 所有接口都需要提供 project_name 参数来指定操作的项目
- 与知识图谱服务（kg_service）交互来管理角色信息

**主要接口**：

- **获取角色列表**：

  - `GET /character/list`
  - 参数：
    - `project_name`（字符串，项目名称）
  - 返回：
    - `characters`（列表，角色信息列表）
    - `locked_entities`（列表，被锁定的角色名称列表）

- **更新角色信息**：

  - `POST /character/update`
  - 参数：
    - `project_name`（字符串，项目名称）
    - `name`（字符串，角色名称）
    - `attributes`（对象，角色属性）
  - 返回：
    - 更新成功或失败的状态

- **锁定/解锁角色**：

  - `POST /character/toggle_lock`
  - 参数：
    - `project_name`（字符串，项目名称）
    - `entity_name`（字符串，角色名称）
  - 返回：
    - `is_locked`（布尔值，角色当前的锁定状态）

- **删除角色**：
  - `DELETE /character/entity/<name>`
  - 参数：
    - `project_name`（字符串，项目名称，通过查询参数传递）
    - `name`（字符串，角色名称，通过 URL 参数传递）
  - 返回：
    - 删除成功或失败的状态

### 3. 章节管理接口 (`chapter_controller.py`)

**功能描述**：

- 提供章节管理相关的 API 接口
- 支持章节的创建、获取、保存、生成和分割功能
- 通过 llm_service 获取章节内容，确保统一的内容访问方式

**主要接口**：

- `POST /chapter/create`：创建新章节
- `GET /chapter/content`：获取指定章节的内容
- `POST /chapter/save`：保存章节内容
- `POST /chapter/generate`：使用 AI 生成章节内容
- `POST /chapter/split-text`：将章节内容分割成多个子章节，使用配置文件中的 window_size 参数控制分割大小
- `GET /chapter/list`：获取项目的所有章节列表
- `POST /api/chapter/save_scenes`：保存修改后的场景内容
  - 接收参数：
    - `project_name`（字符串，项目名称）
    - `chapter_name`（字符串，章节名称）
    - `scenes`（列表，场景列表）
      - 每个场景包含：`index`（序号）、`span`（分割片段）、`scene`（场景描述）、`prompt`（提示词）
  - 处理逻辑：
    - 根据场景序号找到对应的文件夹
    - 将分割片段保存到 `span.txt`
    - 将场景描述和提示词保存到 `prompt.json`

### 3. 媒体生成接口 (`media_controller.py`)

**功能描述**：

- 提供图像和音频生成的相关接口
- 支持单个和批量生成
- 提供任务进度查询和取消功能
- 处理 ComfyUI 的输出，包括保存的图片和预览图片
- 支持音频生成和管理

**主要接口**：

1. **图像生成**

   - `POST /media/generate_images`：生成一个或多个图片
   - 接收参数：
     - `project_name`（字符串，项目名称）
     - `chapter_name`（字符串，章节名称）
     - `prompts`（数组）：每个元素包含：
       - `id`（数字，场景 ID）
       - `prompt`（字符串，提示词）
     - `imageSettings`（对象，图片设置，包含宽度、高度等）
     - `workflow`（字符串，可选，工作流名称，默认为 "default_workflow.json"）
     - `params`（对象，可选，生成参数）
   - 返回：任务 ID 和总任务数

2. **音频生成**

   - `POST /media/generate-audio`：生成单个音频文件
   - 接收参数：
     - `project_name`（字符串，项目名称）
     - `chapter_name`（字符串，章节名称）
     - `audioSettings`（对象）：
       - `voice`（字符串，语音名称）
       - `rate`（字符串，语速，如 "+0%"）
     - `prompts`（数组）：每个元素包含：
       - `id`（数字，场景 ID）
       - `prompt`（字符串，文本内容）
   - 返回：任务 ID 和总任务数

3. **进度查询**

   - `GET /media/progress`：查询任务进度
   - 接收参数：
     - `task_id`（字符串，任务 ID）
   - 返回：
     - `status`：任务状态（running/completed/error/cancelled）
     - `current`：当前进度
     - `total`：总任务数
     - `task_type`：任务类型（audio/image）
     - `errors`：错误信息数组

4. **任务取消**

   - `POST /media/cancel`：取消正在进行的任务
   - 接收参数：
     - `task_id`（字符串，任务 ID）
   - 返回：取消操作是否成功

5. **媒体文件获取**
   - `GET /media/audio`：获取音频文件
   - `GET /media/image`：获取图片文件
   - 接收参数：
     - `project_name`（字符串，项目名称）
     - `chapter_name`（字符串，章节名称）
     - `span_id`（字符串，span ID）
     - `file_name`（字符串，文件名，仅音频需要）

**任务管理**：

- 使用任务 ID 跟踪每个生成任务
- 维护任务状态、进度和错误信息
- 支持任务取消和清理
- 自动生成随机种子（图片生成）
- 处理 ComfyUI 的 WebSocket 消息（图片生成）
- 获取和处理 ComfyUI 的历史记录（图片生成）

**错误处理**：

- 记录详细的错误信息
- 支持多种错误类型：
  - 工作流加载失败
  - 图片生成失败
  - 图片保存失败
  - WebSocket 连接失败
  - ComfyUI 服务器错误
  - 音频生成失败
  - 参数验证错误
- 错误信息包含在任务状态中返回给前端

**输出处理**：

- 图片输出：
  - 保存的图片文件
  - 预览图片
  - 节点输出信息
  - 图片文件命名包含时间戳和种子信息
- 音频输出：
  - WAV 格式音频文件
  - 文件名包含时间戳
  - 支持批量生成时的序号
- 自动创建输出目录

### 4. 系统管理接口 (`admin_controller.py`)

**功能描述**：

- 提供系统管理相关的 API 接口，包括修改配置文件、获取配置文件内容等功能。
- 在返回配置时会自动移除敏感信息（如 API keys）。
- 支持批量更新多个配置项。

**提供的接口**：

- **获取配置文件**：

  - `GET /api/admin/config`：获取当前的配置文件内容，以 JSON 格式返回。
  - 接收参数：无。
  - 返回值会自动移除敏感信息。

- **更新配置文件**：
  - `POST /api/admin/config`：更新配置文件中的一项或多项设置。
  - 接收参数：JSON 对象，包含要更新的配置项。
  - 支持嵌套的配置项更新。
  - 返回更新后的完整配置（同样会移除敏感信息）。

### 5. 视频生成接口 (`video_controller.py`)

**功能描述**：

- 提供视频生成和获取的 API 接口
- 支持自定义视频效果参数
- 提供视频文件的下载功能

**主要接口**：

1. **视频生成**

   - `POST /generate-video`：生成章节视频
   - 接收参数：
     - `project_name`（字符串，项目名称）
     - `chapter_name`（字符串，章节名称）
     - `settings`（对象，可选的视频设置）：
       - `zoom_factor`：缩放因子
       - `pan_intensity`：平移强度
       - `font_name`：字体名称
       - `font_size`：字体大小
       - `resolution`：视频分辨率
   - 返回：生成的视频文件路径

2. **视频获取**
   - `GET /get-video`：获取生成的视频文件
   - 接收参数：
     - `project_name`（字符串，项目名称）
     - `chapter_name`（字符串，章节名称）
   - 返回：视频文件（MP4 格式）

**错误处理**：

- 404：章节或视频文件不存在
- 500：视频生成过程中的其他错误

## 四、服务层说明

### 1. 单例服务基类 (`singleton_service.py`)

- 实现了单例模式的基类，确保服务类只有一个实例
- 所有需要单例的服务类都继承自这个基类
- 使用元类实现单例模式，确保线程安全

**主要功能**：

- 自动实现单例模式
- 线程安全的实例创建
- 支持继承和多态

### 2. LLM 服务 (`llm_service.py`)

**功能描述**：

- 提供与 LLM 相关的业务逻辑，包括文本生成、续写、章节管理等功能
- 负责提示词模板的加载和填充，实现了模板缓存机制，提高加载效率
- 提供章节内容的读取和管理功能
- 处理 LLM API 的调用和响应
- 提供灵活的文本分割功能，支持整体处理和滑动窗口两种模式
- 优化的工具调用处理，只在有可用工具时才进行工具调用处理

**主要功能**：

1. **文本管理**

   - 文本生成：根据提示词生成文本内容
   - 文本续写：基于已有内容继续生成故事
   - 文本分割：将长文本分割成合适的片段

2. **提示词处理**

   - 批量翻译：支持批量将场景描述转换为 AI 绘图提示词
   - 实体整合：自动从知识图谱获取实体信息并融入提示词
   - 模板管理：缓存和管理提示词模板

3. **角色管理**

   - 角色提取：从文本中识别和提取角色信息
   - 知识图谱：与知识图谱服务（kg_service）交互，维护角色关系
   - 实体查询：支持查询和更新实体信息

4. **API 调用优化**
   - 异步处理：支持异步 API 调用，提高性能
   - 错误处理：完善的错误处理和重试机制
   - SSL 配置：灵活的 SSL 验证配置

**主要方法**：

- **generate_text**：根据提示词生成文本内容，支持使用上一章内容作为上下文
- **continue_story**：根据已有内容续写故事，支持使用上一章内容作为上下文
- **get_chapter_content**：获取指定章节的 content.txt 文件内容
- **get_latest_chapter**：获取项目中最新的章节编号
- **split_text_and_generate_prompts**：分割文本并生成提示词，支持两种模式：
  - 整体处理模式（window_size <= 0）：将整个文本作为一个块发送给 LLM 处理
  - 滑动窗口模式（window_size > 0）：使用指定大小的滑动窗口分块处理，保持上下文连贯性
  - window_size 参数从配置文件的 llm.window_size 读取，可在配置文件中统一管理
- **translate_prompt**：将场景描述翻译为 AI 绘图提示词
  - 支持批量处理（每批 5 个提示词）
  - 自动从知识图谱获取相关实体信息
  - 保持提示词的独立性和完整性
- **extract_character**：从文本中提取角色信息
  - 识别文本中的角色及其特征
  - 自动更新知识图谱
  - 返回提取结果和关系信息

**内部机制**：

- **提示词模板缓存**：

  - 使用类级别的缓存字典存储已加载的提示词模板
  - 首次加载时从文件读取并缓存
  - 后续使用时优先从缓存获取，避免重复的文件 I/O 操作

- **文本分割机制**：

  - 从配置文件读取 window_size，控制每个块包含的段落数
  - 实现段落重叠机制，确保上下文连贯性
  - 使用异步并行处理提高效率
  - 自动去重重叠部分的场景
  - 提供详细的日志记录，方便调试和监控

- **工具调用优化**：
  - 只在有可用工具且工具列表不为空时才进行工具调用处理
  - 减少不必要的工具调用和处理开销
  - 提供更清晰的日志记录，便于追踪工具调用过程

### 3. 知识图谱服务 (`kg_service.py`)

**功能描述**：

- 提供知识图谱的管理功能，包括实体和关系的增删改查。
- 实现了缓存机制，提高查询效率。
- 支持按项目隔离数据，确保数据安全。
- 提供工具注册机制，支持 LLM 调用。
- 优化的文件 I/O 操作，减少不必要的保存操作。

**主要功能**：

- **实体管理**：

  - `inquire_entities`: 查询实体信息，支持查询单个或多个实体
  - `new_entity`: 新增单个实体
  - `modify_entity`: 修改单个实体
  - `delete_entity`: 删除单个实体
  - `inquire_entity_list`: 获取项目中的所有实体列表
  - `inquire_entity_names`: 获取项目中的所有实体名称
  - `inquire_entity_relationships`: 查询指定实体的所有关系

- **关系管理**：

  - `new_relationship`: 新增单个关系
  - `modify_relationship`: 修改单个关系
  - `delete_relationship`: 删除单个关系

- **高级查询**：
  - `find_paths`: 查找两个实体之间的所有可能路径

**内部机制**：

- **数据存储**：

  - 使用 JSON 文件存储知识图谱数据
  - 实现文件锁机制，确保并发安全
  - 支持按项目隔离数据
  - 自动备份和恢复机制
  - 优化的保存策略，减少文件 I/O 操作

- **缓存系统**：

  - 实现内存缓存，提高查询效率
  - 支持缓存自动失效和更新
  - 线程安全的缓存操作
  - 优化的缓存更新策略，避免频繁的文件 I/O

- **错误处理**：

  - 统一的错误类型定义
  - 详细的错误信息和追踪
  - 支持事务回滚

- **工具集成**：
  - 所有公开方法都可以被 LLM 调用
  - 工具描述自动生成，包含：
    - 方法名称和功能说明
    - 参数列表和类型
    - 返回值说明
    - 错误处理说明

### 4. 图像生成服务 (`image_service.py`)

**功能描述**：

- 负责与 ComfyUI 交互，提供图像生成相关的业务逻辑。
- 支持实时进度监控和任务取消。
- 提供工作流管理功能。
- 提供完善的错误处理和状态管理机制。

**主要功能**：

- **图片生成**：

  - 支持单张和批量图片生成
  - 使用 WebSocket 监控 ComfyUI 的执行进度
  - 支持自定义生成参数（步数、CFG、尺寸等）
  - 为每次生成自动生成随机种子，确保图片的多样性
  - 将种子信息添加到文件名，便于复现
  - 将图片保存到正确的 span 目录

- **进度监控**：

  - 通过 WebSocket 实时获取 ComfyUI 的执行状态
  - 计算总体进度和节点进度
  - 支持错误检测和报告
  - 返回详细的任务状态信息（running、completed、cancelled、error）

- **任务管理**：

  - 支持取消正在执行的任务
  - 维护任务状态、进度和错误信息
  - 提供任务查询接口
  - 支持错误恢复和重试机制

- **工作流管理**：
  - 加载和验证工作流文件
  - 支持动态替换工作流中的提示词和参数
  - 提供工作流列表和详情查询功能
  - 自动提取工作流的关键信息（采样器、图片尺寸等）
  - 管理工作流的版本和参数
  - 提供工作流文件不存在时的错误处理

**内部机制**：

- **ComfyUI 交互**：

  - 使用 REST API 提交任务和查询状态
  - 通过 WebSocket 监听实时进度
  - 支持任务中断和清理
  - 自动更新工作流中的随机种子
  - 处理 WebSocket 消息编码和解码

- **文件管理**：

  - 自动创建必要的目录结构
  - 生成包含种子信息的唯一文件名
  - 管理临时文件和输出文件
  - 管理工作流文件
  - 验证输出目录的存在性

- **错误处理**：
  - 完善的错误检测和报告机制
  - 支持重试和恢复
  - 详细的错误日志
  - 任务级别的错误状态和信息管理
  - 工作流文件验证和错误处理
  - WebSocket 连接错误处理

### 5. 音频生成服务 (`audio_service.py`)

**功能描述**：

- 基于 edge-tts 实现的音频生成服务，支持单个和批量文本的音频生成
- 提供异步生成机制，支持实时进度监控和任务取消
- 支持配置语音（voice）和语速（rate）等参数
- 实现了任务管理和错误处理机制
- 支持并行处理多个音频生成任务

**主要功能**：

- **音频生成（generate_audio）**：

  - 支持批量文本转音频
  - 异步处理多个音频生成任务
  - 自动创建输出目录
  - 支持自定义语音和语速参数
  - 返回任务 ID 和总任务数

- **任务管理**：
  - 使用时间戳生成唯一任务 ID
  - 维护任务状态、进度和错误信息
  - 支持任务取消和清理
  - 提供任务进度查询接口
  - 错误处理和日志记录

**内部机制**：

- **任务跟踪**：

  - 使用字典存储任务信息
  - 包含任务总数、完成数、状态和错误信息
  - 支持任务状态转换（running/completed/error/cancelled）
  - 自动清理已完成的任务

- **并行处理**：

  - 使用 asyncio 实现并行音频生成
  - 支持批量处理多个文本
  - 任务取消时自动清理临时文件
  - 错误处理不影响其他任务继续执行

- **错误处理**：

  - 详细的错误日志记录
  - 支持单个任务的错误恢复
  - 批量任务中的错误不影响其他任务
  - 任务取消时的资源清理

- **文件管理**：
  - 自动创建输出目录
  - 生成唯一的音频文件名
  - 支持临时文件的创建和清理
  - 文件写入的异常处理

**主要方法**：

- `generate_audio`：生成音频文件

  - 参数：prompts（文本列表）、output_dirs（输出目录列表）、voice（语音）、rate（语速）
  - 返回：任务 ID 和任务信息

- `get_generation_progress`：获取生成进度

  - 参数：task_id（任务 ID）
  - 返回：任务状态、当前进度、总数和错误信息

- `cancel_generation`：取消生成任务

  - 参数：task_id（任务 ID）
  - 返回：取消操作是否成功

- `_process_audio_batch`：处理音频批量生成

  - 内部方法，处理实际的音频生成过程
  - 支持并行处理多个音频生成任务
  - 处理任务取消和错误情况

- `_format_voice_name`：格式化语音名称
  - 处理不同格式的语音名称
  - 提供默认语音配置

**信号处理**：

- 注册系统信号处理器
- 优雅处理中断信号
- 确保资源正确释放
- 防止进程异常退出

**环境配置**：

- 禁用代理设置
- 配置日志记录
- 初始化任务管理器
- 设置信号处理器

### 6. 视频生成服务 (`video_service.py`)

**功能描述**：

- 基于 moviepy 实现的视频生成服务，支持将图片和音频合成为视频
- 提供异步生成机制和多线程处理
- 支持自定义视频效果（缩放、平移）和字幕样式
- 实现了单例模式，确保资源的有效利用

**主要功能**：

- **视频生成**：

  - 支持整章节的视频生成
  - 自动按顺序处理所有场景
  - 并行处理多个视频片段
  - 自动合并为完整视频
  - 支持自定义视频参数

- **效果处理**：
  - 支持图片缩放效果
  - 支持平移特效
  - 支持字幕显示
  - 自定义分辨率和帧率

**内部机制**：

- **并行处理**：

  - 使用 ThreadPoolExecutor 实现并行处理
  - 每个场景独立生成视频片段
  - 最后统一合并所有片段

- **资源管理**：

  - 自动加载和验证资源文件
  - 包括图片、音频和文本
  - 自动创建输出目录
  - 资源文件的异常处理

- **配置管理**：
  - 默认视频配置
  - 支持自定义参数覆盖
  - 包括缩放因子、平移强度等
  - 字体和分辨率设置

**主要方法**：

- `generate_video_async`：异步生成视频

  - 参数：chapter_path（章节路径）、video_settings（视频设置）
  - 返回：生成的视频文件路径

- `generate_video`：生成视频主方法

  - 支持多线程处理
  - 自动排序和处理子文件夹
  - 合并所有视频片段
  - 输出最终视频文件

- `_create_clip`：创建单个视频片段

  - 加载资源文件
  - 应用视频效果
  - 添加字幕
  - 合成音频

- `_apply_effects`：应用视频效果
  - 实现缩放效果
  - 实现平移效果
  - 支持自定义参数

## 五、工具类（utils）

### 1. 提示词管理工具 (`prompt_manager.py`)

**功能描述**：

- 提供提示词管理功能。
- **加载提示词模板**：从 `prompts/` 文件夹中加载提示词模板。
- **替换提示词中的变量**：实现提示词的动态更新，以适应不同的创作需求。

**提供的接口**：

- `load_prompt(template_name)`：加载指定的提示词模板。
- `replace_variables(prompt, variables)`：替换提示词中的变量。

### 2. 上下文管理工具 (`context_manager.py`)

**功能描述**：

- 负责上下文管理，通过知识图谱（KG）管理上下文信息。
- **构建上下文字符串**：确保生成内容的连贯性。
- **更新上下文**：在执行知识图谱数据的增删改操作时，自动更新上下文。

**提供的接口**：

- `build_context(kg_data, project_name)`：根据知识图谱数据构建上下文字符串。
- `update_context(kg_data, project_name)`：更新上下文信息。

### 3. 文件管理工具 (`file_manager.py`)

**功能描述**：

- 提供文件管理工具方法。
- **创建文件夹**：创建指定的文件夹。
- **读取文件内容**：读取指定文件的内容。
- **保存文件内容**：将内容保存到指定文件。
- **删除文件**：删除指定文件。

**提供的接口**：

- `create_folder(folder_path)`：创建文件夹。
- `read_file(file_path)`：读取文件内容。
- `write_file(file_path, content)`：保存文件内容。
- `delete_file(file_path)`：删除文件。

## 六、项目依赖管理

项目依赖的第三方库包括 OpenAI 库、FastAPI 框架、edge tts 库等，通过 `requirements.txt` 文件进行管理，方便项目的安装和部署。

## 七、项目部署说明

项目部署在服务器上，配置好 FastAPI 框架和相关依赖库，设置好 LLM 和 ComfyUI 的 API 接口地址和认证信息，启动 FastAPI 服务器，即可对外提供服务。前端通过调用 API 接口与后端进行交互，实现智能创作平台的各项功能。

## 八、保存文件规则

### 图片文件名规则

- **单张图片生成**：生成的图片文件名包含种子数、日期和时间戳，格式为：`image_YYYY-MM-DD_HH-mm-SS_seed_<seed_number>.png`。例如：`image_2025-02-05_10-15-30_seed_12345.png`。
- **批量图片生成**：每张图片的文件名同样包含种子数、日期和时间戳，格式为：`image_<batch_index>_YYYY-MM-DD_HH-mm-SS_seed_<seed_number>.png`。例如：`image_0_2025-02-05_10-15-30_seed_12345.png`、`image_1_2025-02-05_10-15-30_seed_67890.png`。

### 音频文件名规则

- **单段音频生成**：生成的音频文件名包含日期和时间戳，格式为：`audio_YYYY-MM-DD_HH-mm-SS.wav`。例如：`audio_2025-02-05_10-15-30.wav`。
- **多段音频生成**：每段音频的文件名包含日期、时间戳和索引，格式为：`audio_<index>_YYYY-MM-DD_HH-mm-SS.wav`。例如：`audio_0_2025-02-05_10-15-30.wav`、`audio_1_2025-02-05_10-15-30.wav`。

## 九、总结

- 在接口设计中，种子数不再作为参数传入，而是由系统在生成图片时自动生成。这样既简化了接口调用，又确保了生成的图片文件名中包含种子数，符合项目需求。
- 接口层通过传递 `project_name`、`chapter_id` 和 `span_id`，确保生成的图片或音频文件能够正确地保存到对应的 `span` 文件夹中，便于管理和使用。
- 批量生成接口能够返回生成的进度给前端，并且可以中断生成，提高了用户体验和系统的灵活性。
- 图片和音频文件名的规则清晰明了，便于用户识别和管理生成的文件。
- 翻译功能在 `llm_service.py` 中实现，并在 `chapter_controller.py` 中提供了相应的接口，确保功能完整性和可用性。
- LLM 上下文管理通过知识图谱（KG）实现，确保生成内容的连贯性和一致性。

### 提示词系统

#### 1. 模板设计

提示词模板采用占位符设计，支持动态内容注入：

- `{tools}`：知识图谱工具的描述和参数说明
- `{scene_text}`, `{text_content}` 等：用户输入内容
- `{gender}`, `{age}`, `{role}` 等：角色属性

#### 2. 主要模板

- **novel_writing.txt**：小说创作模板，指导 LLM 进行创作并维护知识图谱
- **story_continuation.txt**：故事续写模板，确保情节连贯性
- **character_extraction.txt**：角色信息提取模板，规范化角色属性
- **character_generation.txt**：角色描述生成模板，生成适合 AI 绘图的提示词
- **scene_description.txt**：场景描述生成模板，将文本场景转换为绘图提示词

#### 3. 工具集成

- 模板中的 `{tools}` 占位符会被自动替换为最新的工具描述
- 工具描述包含：名称、功能说明、参数列表、必填参数标记
- LLM 可以根据需要自主选择合适的工具来完成任务

### KGService

知识图谱服务，提供对知识图谱的基本操作。每个项目的知识图谱都存储在独立的 JSON 文件中。

#### 主要功能

1. 实体管理

   - `inquire_entities`: 查询实体信息，支持查询单个或多个实体
   - `new_entity`: 新增单个实体
   - `modify_entity`: 修改单个实体
   - `delete_entity`: 删除单个实体
   - `inquire_entity_list`: 获取项目中的所有实体列表
   - `inquire_entity_names`: 获取项目中的所有实体名称
   - `inquire_entity_relationships`: 查询指定实体的所有关系

2. 关系管理

   - `new_relationship`: 新增单个关系
   - `modify_relationship`: 修改单个关系
   - `delete_relationship`: 删除单个关系

3. 实体锁定

   - `toggle_entity_lock`: 切换实体的锁定状态
   - `get_locked_entities`: 获取所有被锁定的实体
   - `is_entity_locked`: 检查实体是否被锁定

4. 路径查找
   - `find_paths`: 查找两个实体之间的所有可能路径

#### 数据结构

知识图谱使用 JSON 格式存储，包含以下主要字段：

```json
{
  "entities": [
    {
      "name": "实体名称",
      "attributes": {
        "key": "value"
      }
    }
  ],
  "relationships": [
    {
      "source": "源实体名称",
      "target": "目标实体名称",
      "type": "关系类型",
      "attributes": {
        "key": "value"
      }
    }
  ],
  "locked_entities": ["被锁定的实体名称"]
}
```

#### 缓存机制

为了提高性能，KGService 实现了内存缓存机制：

1. 首次访问时加载知识图谱到内存
2. 所有修改操作先更新内存中的数据
3. 调用 `save_kg` 方法时才会将更改写入文件
4. 可以通过 `save_kg` 参数控制是否在操作后立即保存到文件

```
启动 FastAPI 服务器，即可对外提供服务

```

```

```
